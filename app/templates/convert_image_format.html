<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Image Format Converter</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 text-slate-800">
  <div class="max-w-4xl mx-auto px-4 py-12">
    <header class="mb-10">
      <a href="/" class="inline-flex items-center text-slate-600 hover:text-slate-800 mb-4">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
        </svg>
        Back to tools
      </a>
      <h1 class="text-3xl font-bold tracking-tight">Image Format Converter</h1>
      <p class="text-slate-600 mt-2">Convert images between different formats. Supports HEIC, JPG, PNG, WebP, BMP, TIFF, ICO, and GIF.</p>
    </header>

    <form id="convertForm" method="POST" action="/convert-image-format" enctype="multipart/form-data" class="bg-white rounded-2xl shadow-sm ring-1 ring-slate-200 p-8">
      
      <!-- File Upload Area -->
      <div class="mb-8">
        <label class="block text-sm font-medium text-slate-700 mb-2">
          Upload Images
        </label>
        <div id="dropZone" class="relative border-2 border-dashed border-slate-300 rounded-xl p-8 text-center hover:border-blue-400 transition-colors">
          <input 
            type="file" 
            name="image_files" 
            id="imageFiles" 
            multiple 
            accept="image/*,.heic,.heif"
            class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
          />
          <svg class="mx-auto h-12 w-12 text-slate-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
          </svg>
          <p class="text-sm text-slate-600">Drop images here or click to browse</p>
          <p class="text-xs text-slate-500 mt-1">Supports HEIC, JPG, PNG, WebP, BMP, TIFF, ICO, GIF</p>
        </div>
        <div id="fileList" class="mt-4 space-y-2"></div>
      </div>

      <!-- Output Format Selection -->
      <div class="mb-6">
        <label class="block text-sm font-medium text-slate-700 mb-2">
          Convert To
        </label>
        <div class="grid grid-cols-4 gap-2">
          <button type="button" class="format-btn px-3 py-2 border border-slate-300 rounded-lg text-sm hover:bg-blue-50 hover:border-blue-400" data-format="jpeg">
            JPG/JPEG<br><span class="text-xs text-slate-500">Universal</span>
          </button>
          <button type="button" class="format-btn px-3 py-2 border border-blue-400 bg-blue-50 rounded-lg text-sm" data-format="png">
            PNG<br><span class="text-xs text-slate-500">Lossless</span>
          </button>
          <button type="button" class="format-btn px-3 py-2 border border-slate-300 rounded-lg text-sm hover:bg-blue-50 hover:border-blue-400" data-format="webp">
            WebP<br><span class="text-xs text-slate-500">Modern</span>
          </button>
          <button type="button" class="format-btn px-3 py-2 border border-slate-300 rounded-lg text-sm hover:bg-blue-50 hover:border-blue-400" data-format="gif">
            GIF<br><span class="text-xs text-slate-500">Animated</span>
          </button>
          <button type="button" class="format-btn px-3 py-2 border border-slate-300 rounded-lg text-sm hover:bg-blue-50 hover:border-blue-400" data-format="bmp">
            BMP<br><span class="text-xs text-slate-500">Bitmap</span>
          </button>
          <button type="button" class="format-btn px-3 py-2 border border-slate-300 rounded-lg text-sm hover:bg-blue-50 hover:border-blue-400" data-format="tiff">
            TIFF<br><span class="text-xs text-slate-500">Pro</span>
          </button>
          <button type="button" class="format-btn px-3 py-2 border border-slate-300 rounded-lg text-sm hover:bg-blue-50 hover:border-blue-400" data-format="ico">
            ICO<br><span class="text-xs text-slate-500">Icon</span>
          </button>
        </div>
        <input type="hidden" name="output_format" id="outputFormat" value="png" />
      </div>

      <!-- Transparency Option -->
      <div class="mb-6" id="transparencyOption">
        <label class="flex items-center">
          <input 
            type="checkbox" 
            name="keep_transparency" 
            id="keepTransparency"
            checked
            class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500"
          />
          <span class="ml-2 text-sm text-slate-700">Keep transparency (if supported by format)</span>
        </label>
      </div>

      <!-- Quality Slider (for lossy formats) -->
      <div class="mb-6" id="qualitySection">
        <label class="block text-sm font-medium text-slate-700 mb-2">
          Quality: <span id="qualityValue" class="text-blue-600 font-semibold">95</span>%
          <span class="text-xs text-slate-500 ml-2">(for JPEG, WebP)</span>
        </label>
        <input 
          type="range" 
          name="quality" 
          id="quality" 
          min="1" 
          max="100" 
          value="95"
          class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer"
        />
        <div class="flex justify-between text-xs text-slate-500 mt-1">
          <span>Smaller file</span>
          <span>Better quality</span>
        </div>
      </div>

      <!-- Format Information -->
      <div class="mb-6 p-4 bg-blue-50 rounded-lg" id="formatInfo">
        <h3 class="text-sm font-semibold text-blue-900 mb-1">PNG Format</h3>
        <p class="text-xs text-blue-800">Lossless compression, supports transparency. Best for graphics, screenshots, and images with text.</p>
      </div>

      <!-- Submit Button -->
      <button 
        type="submit" 
        id="submitBtn"
        disabled
        class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg font-medium disabled:bg-slate-300 disabled:cursor-not-allowed hover:bg-blue-700 transition-colors"
      >
        Convert Images
      </button>

      <!-- Progress Message -->
      <div id="progressMessage" class="hidden mt-4 text-center text-slate-600">
        <svg class="inline-block animate-spin h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Converting images...
      </div>
    </form>
  </div>

  <script>
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('imageFiles');
    const fileList = document.getElementById('fileList');
    const submitBtn = document.getElementById('submitBtn');
    const qualitySlider = document.getElementById('quality');
    const qualityValue = document.getElementById('qualityValue');
    const progressMessage = document.getElementById('progressMessage');
    const form = document.getElementById('convertForm');
    const formatBtns = document.querySelectorAll('.format-btn');
    const outputFormat = document.getElementById('outputFormat');
    const formatInfo = document.getElementById('formatInfo');
    const qualitySection = document.getElementById('qualitySection');
    const transparencyOption = document.getElementById('transparencyOption');

    let selectedFiles = [];
    let selectedFormat = 'png';

    const formatDescriptions = {
      'jpeg': {
        title: 'JPEG/JPG Format',
        desc: 'Lossy compression, no transparency. Best for photos and complex images. Smaller file sizes.',
        showQuality: true,
        showTransparency: false
      },
      'png': {
        title: 'PNG Format',
        desc: 'Lossless compression, supports transparency. Best for graphics, screenshots, and images with text.',
        showQuality: false,
        showTransparency: true
      },
      'webp': {
        title: 'WebP Format',
        desc: 'Modern format with excellent compression. Supports both lossy and lossless, plus transparency.',
        showQuality: true,
        showTransparency: true
      },
      'gif': {
        title: 'GIF Format',
        desc: 'Limited to 256 colors, supports simple animations and transparency. Best for simple graphics.',
        showQuality: false,
        showTransparency: true
      },
      'bmp': {
        title: 'BMP Format',
        desc: 'Uncompressed bitmap format. Large file sizes but perfect quality. No transparency support.',
        showQuality: false,
        showTransparency: false
      },
      'tiff': {
        title: 'TIFF Format',
        desc: 'Professional format with lossless compression. Excellent for archiving and printing.',
        showQuality: false,
        showTransparency: true
      },
      'ico': {
        title: 'ICO Format',
        desc: 'Icon format for Windows. Images will be resized to 256x256 or smaller. Supports transparency.',
        showQuality: false,
        showTransparency: true
      }
    };

    // Format button selection
    formatBtns.forEach(btn => {
      btn.addEventListener('click', (e) => {
        const format = btn.dataset.format;
        selectFormat(format);
      });
    });

    function selectFormat(format) {
      selectedFormat = format;
      outputFormat.value = format;
      
      // Update button styles
      formatBtns.forEach(btn => {
        if (btn.dataset.format === format) {
          btn.classList.add('border-blue-400', 'bg-blue-50');
          btn.classList.remove('border-slate-300');
        } else {
          btn.classList.remove('border-blue-400', 'bg-blue-50');
          btn.classList.add('border-slate-300');
        }
      });
      
      // Update format info
      const info = formatDescriptions[format];
      formatInfo.innerHTML = `
        <h3 class="text-sm font-semibold text-blue-900 mb-1">${info.title}</h3>
        <p class="text-xs text-blue-800">${info.desc}</p>
      `;
      
      // Show/hide quality and transparency options
      qualitySection.style.display = info.showQuality ? 'block' : 'none';
      transparencyOption.style.display = info.showTransparency ? 'block' : 'none';
    }

    // Quality slider update
    qualitySlider.addEventListener('input', (e) => {
      qualityValue.textContent = e.target.value;
    });

    // Drag and drop
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('border-blue-400', 'bg-blue-50');
    });

    dropZone.addEventListener('dragleave', (e) => {
      e.preventDefault();
      dropZone.classList.remove('border-blue-400', 'bg-blue-50');
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('border-blue-400', 'bg-blue-50');
      handleFiles(e.dataTransfer.files);
    });

    // File input change
    fileInput.addEventListener('change', (e) => {
      handleFiles(e.target.files);
    });

    function handleFiles(files) {
      selectedFiles = Array.from(files);
      updateFileList();
      submitBtn.disabled = selectedFiles.length === 0;
    }

    function updateFileList() {
      fileList.innerHTML = '';
      selectedFiles.forEach((file, index) => {
        const fileSize = (file.size / 1024 / 1024).toFixed(2);
        const fileExt = file.name.split('.').pop().toUpperCase();
        const fileItem = document.createElement('div');
        fileItem.className = 'flex items-center justify-between p-3 bg-slate-50 rounded-lg';
        fileItem.innerHTML = `
          <div class="flex items-center">
            <svg class="w-5 h-5 text-slate-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
            <div>
              <p class="text-sm font-medium text-slate-700">${file.name}</p>
              <p class="text-xs text-slate-500">${fileSize} MB • ${fileExt}</p>
            </div>
          </div>
          <button type="button" onclick="removeFile(${index})" class="text-red-500 hover:text-red-700">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        `;
        fileList.appendChild(fileItem);
      });
    }

    function removeFile(index) {
      selectedFiles.splice(index, 1);
      updateFileList();
      submitBtn.disabled = selectedFiles.length === 0;
      
      // Update file input
      const dt = new DataTransfer();
      selectedFiles.forEach(file => dt.items.add(file));
      fileInput.files = dt.files;
    }

    // Form submission
    form.addEventListener('submit', (e) => {
      if (selectedFiles.length === 0) {
        e.preventDefault();
        alert('Please select at least one image file');
        return;
      }
      
      e.preventDefault();
      const formData = new FormData();
      
      // Add files
      selectedFiles.forEach(file => {
        formData.append('image_files', file);
      });
      
      // Add other fields
      formData.append('output_format', outputFormat.value);
      formData.append('quality', document.getElementById('quality').value);
      formData.append('keep_transparency', document.getElementById('keepTransparency').checked);
      
      // Submit
      submitBtn.disabled = true;
      progressMessage.classList.remove('hidden');
      
      fetch('/convert-image-format', {
        method: 'POST',
        body: formData
      })
      .then(response => {
        if (!response.ok) {
          return response.json().then(err => Promise.reject(err));
        }
        // Get filename from Content-Disposition header or use default
        const contentDisposition = response.headers.get('Content-Disposition');
        let filename = `converted_images.zip`;
        if (contentDisposition) {
          const matches = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/.exec(contentDisposition);
          if (matches != null && matches[1]) {
            filename = matches[1].replace(/['"]/g, '');
          }
        }
        return response.blob().then(blob => ({ blob, filename }));
      })
      .then(({ blob, filename }) => {
        // Download the file
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        // Reset form
        selectedFiles = [];
        updateFileList();
        fileInput.value = '';
        submitBtn.disabled = true;
        progressMessage.classList.add('hidden');
      })
      .catch(error => {
        console.error('Conversion error:', error);
        if (error && error.detail) {
          alert('Error: ' + error.detail);
        } else {
          alert('An error occurred while converting the images.');
        }
        submitBtn.disabled = false;
        progressMessage.classList.add('hidden');
      });
    });
  </script>
</body>
</html>