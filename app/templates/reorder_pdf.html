<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reorder & Delete Pages</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .dragging { opacity: 0.6; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 text-slate-800">
  <div class="max-w-5xl mx-auto px-4 py-10">
    <header class="mb-8">
      <a href="/" class="text-sm text-blue-700 hover:underline">‚Üê Back</a>
      <h1 class="text-3xl font-bold tracking-tight mt-2">Reorder & Delete Pages</h1>
      <p class="text-slate-600 mt-2">Upload a PDF, drag thumbnails to reorder, click the trash to delete pages, then export.</p>
    </header>

    <section id="uploader" class="space-y-6">
      <div id="dropzone" class="border-2 border-dashed border-slate-300 rounded-xl p-8 bg-white shadow-sm transition">
        <div class="flex items-center justify-center flex-col gap-4 text-center">
          <div class="w-16 h-16 rounded-full bg-sky-50 flex items-center justify-center text-3xl">üì•</div>
          <div>
            <p class="font-medium">Drag & drop your PDF here</p>
            <p class="text-sm text-slate-500">or click to choose a file</p>
          </div>
          <input id="pdf_file" name="pdf_file" type="file" accept="application/pdf,.pdf" class="hidden" required />
          <button type="button" id="choose-btn" class="px-4 py-2 rounded-lg bg-sky-600 text-white hover:bg-sky-700 transition">Choose PDF</button>
          <p id="file-name" class="text-sm text-slate-600"></p>
        </div>
      </div>
    </section>

    <section id="editor" class="hidden space-y-4">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold">Pages</h2>
        <div class="flex items-center gap-3">
          <button id="reset-btn" class="text-sm text-slate-600 hover:text-slate-800">Reset</button>
          <button id="export-btn" class="px-4 py-2 rounded-lg bg-sky-600 text-white hover:bg-sky-700 transition">Export reordered PDF</button>
        </div>
      </div>
      <ul id="thumb-list" class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-6 gap-4"></ul>
      <p id="hint" class="text-xs text-slate-500">Tip: drag thumbnails to reorder; click üóë to delete/undelete a page.</p>
    </section>
  </div>

  <script>
    const dropzone = document.getElementById('dropzone');
    const chooseBtn = document.getElementById('choose-btn');
    const pdfInput = document.getElementById('pdf_file');
    const fileName = document.getElementById('file-name');
    const uploader = document.getElementById('uploader');
    const editor = document.getElementById('editor');
    const thumbList = document.getElementById('thumb-list');
    const exportBtn = document.getElementById('export-btn');
    const resetBtn = document.getElementById('reset-btn');

    let sessionToken = null;
    let pages = []; // [{page, thumb_url, deleted:false}]
    let dragId = null;

    function renderThumbs() {
      thumbList.innerHTML = '';
      const visible = pages.filter(x => !x.deleted);
      const displayPosByPage = new Map(visible.map((x, i) => [x.page, i + 1]));
      pages.forEach((p) => {
        const li = document.createElement('li');
        li.className = 'rounded-lg ring-1 ring-slate-200 bg-white p-2 flex flex-col items-center gap-2 relative';
        li.draggable = !p.deleted;
        li.dataset.page = p.page;
        const displayPos = displayPosByPage.get(p.page);
        li.innerHTML = `
          <img src="${p.thumb_url}" alt="p${p.page}" class="w-full rounded ${p.deleted ? 'opacity-40' : ''}" />
          <div class="flex items-center justify-between w-full">
            <span class="text-xs text-slate-600">${p.deleted ? '‚Äî' : 'p' + displayPos}</span>
            <button type="button" class="text-xs px-2 py-1 rounded ${p.deleted ? 'bg-emerald-50 text-emerald-700' : 'bg-rose-50 text-rose-700'} toggle-del">${p.deleted ? 'Undo' : 'üóë'}</button>
          </div>
        `;
        li.addEventListener('dragstart', (e) => { dragId = p.page; li.classList.add('dragging'); e.dataTransfer.effectAllowed = 'move'; });
        li.addEventListener('dragend', () => { dragId = null; li.classList.remove('dragging'); });
        li.addEventListener('dragover', (e) => { if (p.deleted) return; e.preventDefault(); e.dataTransfer.dropEffect = 'move'; li.classList.add('ring-sky-300'); });
        li.addEventListener('dragleave', () => { li.classList.remove('ring-sky-300'); });
        li.addEventListener('drop', (e) => {
          if (p.deleted) return;
          e.preventDefault(); li.classList.remove('ring-sky-300');
          if (!dragId || dragId === p.page) return;
          const fromIdx = pages.findIndex(x => x.page === dragId);
          const toIdx = pages.findIndex(x => x.page === p.page);
          const [moved] = pages.splice(fromIdx, 1);
          pages.splice(toIdx, 0, moved);
          renderThumbs();
        });
        li.querySelector('.toggle-del').addEventListener('click', () => {
          p.deleted = !p.deleted; renderThumbs();
        });
        thumbList.appendChild(li);
      });
    }

    function setUploadingUIActive(active) {
      if (active) {
        uploader.classList.add('hidden');
        editor.classList.remove('hidden');
      } else {
        uploader.classList.remove('hidden');
        editor.classList.add('hidden');
      }
    }

    chooseBtn.addEventListener('click', () => pdfInput.click());
    pdfInput.addEventListener('change', async () => { if (pdfInput.files[0]) await initSession(pdfInput.files[0]); });

    ['dragenter','dragover'].forEach(evt => dropzone.addEventListener(evt, (e) => { e.preventDefault(); e.stopPropagation(); dropzone.classList.add('ring-2','ring-sky-400','bg-sky-50/40'); }));
    ['dragleave','drop'].forEach(evt => dropzone.addEventListener(evt, (e) => { e.preventDefault(); e.stopPropagation(); dropzone.classList.remove('ring-2','ring-sky-400','bg-sky-50/40'); }));
    dropzone.addEventListener('drop', async (e) => {
      const dt = e.dataTransfer; if (!dt || !dt.files || !dt.files.length) return;
      const file = dt.files[0]; if (!/\.pdf$/i.test(file.name)) return;
      await initSession(file);
    });

    async function initSession(file) {
      const fd = new FormData(); fd.append('pdf_file', file, file.name);
      const res = await fetch('/reorder/init', { method: 'POST', body: fd });
      if (!res.ok) { alert('Failed to initialize.'); return; }
      const data = await res.json();
      sessionToken = data.token; pages = data.thumbs.map(t => ({ page: t.page, thumb_url: t.thumb_url, deleted: false }));
      setUploadingUIActive(true); renderThumbs();
    }

    resetBtn.addEventListener('click', () => { pages.forEach(p => p.deleted = false); pages.sort((a,b)=>a.page-b.page); renderThumbs(); });

    exportBtn.addEventListener('click', async () => {
      const order = pages.filter(p => !p.deleted).map(p => p.page);
      if (!order.length) { alert('No pages selected.'); return; }
      const res = await fetch('/reorder/apply', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ token: sessionToken, order }) });
      if (!res.ok) { alert('Failed to export.'); return; }
      const blob = await res.blob();
      const cd = res.headers.get('Content-Disposition') || '';
      const nameMatch = cd.match(/filename="?([^";]+)"?/i);
      const suggestedName = nameMatch ? nameMatch[1] : 'reordered.pdf';
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = suggestedName; document.body.appendChild(a); a.click(); a.remove(); window.URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>
